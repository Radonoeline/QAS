<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generateur Données pour Rapport QAS</title>
    <link rel="stylesheet" href="styles.css"> <!-- Intégration du fichier CSS -->
    <script src="papaparse.js"></script>
</head>
<body>
    <h1>Generateur Données pour Rapport QAS</h1>
    <button onclick="openCSV()">Ouvrir CSV</button>
    <input type="file" id="csvFileInput" accept=".csv" style="display:none" onchange="handleFileSelect(event)">
    <button onclick="processDataconsensus()">Consensus/ WID</button>
    <button onclick="processDataconsensus1()">Consensus/ Accuracy</button>
    <button onclick="processDataconsensus2()">Attribut/ Errors</button>
	<button onclick="processDataconsensus3()">Summary Concensus</button>
	<button onclick="processDataconsensus4()">Summary Correctness</button>
	<button onclick="copyResults()">Copy Result</button>

    <div class="tablecontainer">
        <table id="resultsTable" border="1">
            <thead>
                <tr>
                    <th>Worker ID</th>
                    <th>Correcte Majority</th>
                    <th>Correcte Minority</th>
                    <th>Incorrecte Majority</th>
                    <th>Incorrecte Minority</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        let csvData = [];
        let colorsSet = new Set();
        let colorStats = {};

        function openCSV() {
            document.getElementById('csvFileInput').click();
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                Papa.parse(file, {
                    header: true,
                    dynamicTyping: true,
                    complete: function(results) {
                        csvData = results.data.filter(row => row['workerid']); // Filtrer les lignes sans workerid
                        console.log("CSV Data Parsed: ", csvData);
                    }
                });
            }
        }

        function resetResultsTable() {
            const resultsTable = document.getElementById('resultsTable');
            resultsTable.innerHTML = `
                <thead>
                    <tr>
                    <th>Worker ID</th>
                    <th>Correcte Majority</th>
                    <th>Correcte Minority</th>
                    <th>Incorrecte Majority</th>
                    <th>Incorrecte Minority</th>
                    <th>Total</th>
                </tr>
                </thead>
                <tbody></tbody>
            `;
        }

        function processDataconsensus() {
            if (csvData.length === 0) {
                alert('Veuillez d\'abord ouvrir un fichier CSV.');
                return;
            }

            resetResultsTable();

            // Vérification des entêtes
            const headers = Object.keys(csvData[0]);
            console.log("Headers Detected: ", headers);
            
            if (!headers.includes('workerid')) {
                alert('Le fichier CSV ne contient pas la colonne "workerid".');
                return;
            }

            const uniqueEtudiants = [...new Set(csvData.map(row => row['workerid']))];
            const results = calculateResults(uniqueEtudiants);
            displayResults(results);
        }

        function calculateResults(uniqueEtudiants) {
            const results = [];

            uniqueEtudiants.forEach(workerid => {
                let C_MAJ_count = countOccurrences(workerid, 'C', 'MAJ');
                let C_MIN_count = countOccurrences(workerid, 'C', 'MIN');
                let I_MAJ_count = countOccurrences(workerid, 'I', 'MAJ');
                let I_MIN_count = countOccurrences(workerid, 'I', 'MIN');
                let total = C_MAJ_count + C_MIN_count + I_MAJ_count + I_MIN_count;

                results.push({
                    workerid: workerid,
                    C_MAJ: C_MAJ_count,
                    C_MIN: C_MIN_count,
                    I_MAJ: I_MAJ_count,
                    I_MIN: I_MIN_count,
                    Total: total
                });
            });

            // Calculer les totaux
            const totals = {
                workerid: 'Total',
                C_MAJ: results.reduce((acc, curr) => acc + curr.C_MAJ, 0),
                C_MIN: results.reduce((acc, curr) => acc + curr.C_MIN, 0),
                I_MAJ: results.reduce((acc, curr) => acc + curr.I_MAJ, 0),
                I_MIN: results.reduce((acc, curr) => acc + curr.I_MIN, 0),
                Total: results.reduce((acc, curr) => acc + curr.Total, 0)
            };

            results.push(totals);

            return results;
        }

        function countOccurrences(workerid, Correctness, Consensus) {
            return csvData.filter(row => row['workerid'] === workerid && row['Correctness'] === Correctness && row['Consensus'] === Consensus).length;
        }

function displayResults(results) {
    const resultsTable = document.getElementById('resultsTable');
    
    // Changer l'en-tête du tableau
    let thead = document.querySelector('#resultsTable thead');
    if (!thead) {
        thead = document.createElement('thead');
        resultsTable.appendChild(thead);
    }
    thead.innerHTML = `
        <tr>
            <th>Worker ID</th>
            <th>Correcte Majority</th>
            <th>Correcte Minority</th>
            <th>Incorrecte Majority</th>
            <th>Incorrecte Minority</th>
            <th><strong>Total</strong></th> <!-- Mettre en gras -->
        </tr>
    `;

    // Changer le corps du tableau
    let tbody = document.querySelector('#resultsTable tbody');
    if (!tbody) {
        tbody = document.createElement('tbody');
        resultsTable.appendChild(tbody);
    }
    tbody.innerHTML = ''; // Efface le contenu existant du tbody

    results.forEach(result => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${result.workerid}</td>
            <td>${result.C_MAJ}</td>
            <td>${result.C_MIN}</td>
            <td>${result.I_MAJ}</td>
            <td>${result.I_MIN}</td>
            <td><strong>${result.Total}</strong></td> <!-- Mettre en gras -->
        `;
        tbody.appendChild(row);
    });
}


        function processDataconsensus1() {
            if (csvData.length === 0) {
                alert('Veuillez d\'abord charger un fichier CSV.');
                return;
            }

            resetResultsTable();

            const headers = Object.keys(csvData[0]);
            const workeridIndex = headers.indexOf("workerid");
            const correctnessIndex = headers.indexOf("Correctness");
            const consensusIndex = headers.indexOf("Consensus");

            if (workeridIndex === -1 || correctnessIndex === -1 || consensusIndex === -1) {
                alert('Les en-têtes requis ne sont pas présents dans le fichier CSV.');
                return;
            }

            const results = {};
            csvData.forEach(row => {
                const workerid = row["workerid"];
                const correctness = row["Correctness"].toUpperCase();
                const consensus = row["Consensus"].toUpperCase();

                if (!workerid) {
                    return;
                }

                if (!results[workerid]) {
                    results[workerid] = {
                        c: 0,
                        i: 0,
                        total: 0,
                        accuracy: 0
                    };
                }

                if (correctness === 'C') {
                    results[workerid].c++;
                } else if (correctness === 'I') {
                    results[workerid].i++;
                }

                results[workerid].total++;
                results[workerid].accuracy = ((results[workerid].c / results[workerid].total) * 100).toFixed(2) + '%';
            });

            displayResults1(results);
        }

function displayResults1(results) {
    const resultsTable = document.getElementById('resultsTable');
    resultsTable.innerHTML = `
        <thead>
            <tr>
                <th>Worker ID</th>
                <th>Correcte</th>
                <th>Incorrecte</th>
                <th>Total Général</th>
                <th>Accuracy (%)</th>
            </tr>
        </thead>
        <tbody></tbody>`;

    const tbody = resultsTable.querySelector('tbody');
    let totalCorrect = 0;
    let totalIncorrect = 0;
    let totalAccuracySum = 0;

    for (const [workerid, data] of Object.entries(results)) {
        totalCorrect += data.c;
        totalIncorrect += data.i;
        totalAccuracySum += parseFloat(data.accuracy);
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${workerid}</td>
            <td>${data.c}</td>
            <td>${data.i}</td>
            <td>${data.total}</td>
            <td>${data.accuracy}</td>`;
        tbody.appendChild(row);
    }

    // Calcul du grand total de l'accuracy (%)
    const grandTotalAccuracy = totalIncorrect === 0 ? '0.00%' : ((totalCorrect / (totalCorrect + totalIncorrect)) * 100).toFixed(2) + '%';

    // Ajouter la ligne de grand total à la fin du tableau
    const totalRow = document.createElement('tr');
    totalRow.innerHTML = `
        <td><strong>Grand Total</strong></td>
        <td><strong>${totalCorrect}</strong></td>
        <td><strong>${totalIncorrect}</strong></td>
        <td><strong>${totalCorrect + totalIncorrect}</strong></td>
        <td><strong>${grandTotalAccuracy}</strong></td>
    `;
    tbody.appendChild(totalRow);
}


        function processDataconsensus2() {
            if (csvData.length === 0) {
                alert('Veuillez d\'abord charger un fichier CSV.');
                return;
            }

            resetResultsTable();

            colorsSet.clear();
            colorStats = {};

            csvData.forEach(row => {
                if (row['assin_json']) {
                    row['assin_json'].split(',').forEach(color => colorsSet.add(color.trim()));
                }
                if (row['assin_juge_json']) {
                    row['assin_juge_json'].split(',').forEach(color => colorsSet.add(color.trim()));
                }
            });

            colorsSet.forEach(color => {
                colorStats[color] = { marina: 0, diso: 0 };
            });

            csvData.forEach(row => {
                const participantColors = row['assin_json'] ? row['assin_json'].split(',').map(c => c.trim()) : [];
                const jugeColors = row['assin_juge_json'] ? row['assin_juge_json'].split(',').map(c => c.trim()) : [];

                colorsSet.forEach(color => {
                    const inParticipant = participantColors.includes(color);
                    const inJuge = jugeColors.includes(color);

                    if (inParticipant && inJuge) {
                        colorStats[color].marina++;
                    } else if (inParticipant || inJuge) {
                        colorStats[color].diso++;
                    }
                });
            });

            displayResults2();
        }

function displayResults2() {
    const resultsTable = document.getElementById('resultsTable');
    resultsTable.innerHTML = ''; // Efface complètement le contenu existant du tableau

    const headerRow = document.createElement('tr');
    headerRow.innerHTML = `
        <th>Attribut</th>
        <th>Correct</th>
        <th>Incorrect</th>
        <th>Error Rate</th>
        <th>Accuracy</th>`;
    resultsTable.appendChild(headerRow);

    let totalCorrect = 0;
    let totalIncorrect = 0;

    for (let color in colorStats) {
        const marina = colorStats[color].marina;
        const diso = colorStats[color].diso;
        
        totalCorrect += marina;
        totalIncorrect += diso;

        const errorRate = totalIncorrect === 0 ? '0.00%' : ((diso / (marina + diso)) * 100).toFixed(2) + '%';
        const accuracy = ((marina + diso) === 0) ? '0.00%' : ((marina / (marina + diso)) * 100).toFixed(2) + '%';

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${color}</td>
            <td>${marina}</td>
            <td>${diso}</td>
            <td>${errorRate}</td>
            <td>${accuracy}</td>
        `;
        resultsTable.appendChild(row);
    }

    // Ajouter la ligne de grand total
    const totalErrorRate = totalIncorrect === 0 ? '0.00%' : ((totalIncorrect / (totalCorrect + totalIncorrect)) * 100).toFixed(2) + '%';
    const totalAccuracy = ((totalCorrect + totalIncorrect) === 0) ? '0.00%' : ((totalCorrect / (totalCorrect + totalIncorrect)) * 100).toFixed(2) + '%';

    const totalRow = document.createElement('tr');
    totalRow.innerHTML = `
        <td><strong>Total</strong></td>
        <td><strong>${totalCorrect}</strong></td>
        <td><strong>${totalIncorrect}</strong></td>
        <td><strong>${totalErrorRate}</strong></td>
        <td><strong>${totalAccuracy}</strong></td>
    `;
    resultsTable.appendChild(totalRow);
}

function copyResults() {
    const resultsTable = document.getElementById('resultsTable');

    // Sélectionner le contenu du tableau
    const range = document.createRange();
    range.selectNode(resultsTable);
    window.getSelection().removeAllRanges();
    window.getSelection().addRange(range);

    // Copier le texte sélectionné dans le presse-papiers
    document.execCommand('copy');
    window.getSelection().removeAllRanges();

    // Afficher un message de confirmation
    alert('Copié dans Presse-Papier');
}



//display result 3
function processDataconsensus3() {
    if (csvData.length === 0) {
        alert('Veuillez d\'abord charger un fichier CSV.');
        return;
    }

    resetResultsTable();

    const headers = Object.keys(csvData[0]);
    const workeridIndex = headers.indexOf("workerid");
    const correctnessIndex = headers.indexOf("Correctness");
    const consensusIndex = headers.indexOf("Consensus");

    if (workeridIndex === -1 || correctnessIndex === -1 || consensusIndex === -1) {
        alert('Les en-têtes requis ne sont pas présents dans le fichier CSV.');
        return;
    }

    const results = {
        correctMajority: 0,
        correctMinority: 0,
        incorrectMajority: 0,
        incorrectMinority: 0,
        total: 0
    };

    csvData.forEach(row => {
        const correctness = row["Correctness"].toUpperCase();
        const consensus = row["Consensus"].toUpperCase();

        if (correctness === 'C' && consensus === 'MAJ') {
            results.correctMajority++;
        } else if (correctness === 'C' && consensus === 'MIN') {
            results.correctMinority++;
        } else if (correctness === 'I' && consensus === 'MAJ') {
            results.incorrectMajority++;
        } else if (correctness === 'I' && consensus === 'MIN') {
            results.incorrectMinority++;
        }

        results.total++;
    });

    displayTotalResults(results);
}

function displayTotalResults(results) {
    const resultsTable = document.getElementById('resultsTable');
    resultsTable.innerHTML = `
        <thead>
            <tr>
                <th>Statistique</th>
                <th>Nombre ASIN</th>
                <th>Percentage</th>
            </tr>
        </thead>
        <tbody></tbody>`;

    const tbody = resultsTable.querySelector('tbody');

    const percentageCorrectMajority = ((results.correctMajority / results.total) * 100).toFixed(2) + '%';
    const percentageCorrectMinority = ((results.correctMinority / results.total) * 100).toFixed(2) + '%';
    const percentageIncorrectMajority = ((results.incorrectMajority / results.total) * 100).toFixed(2) + '%';
    const percentageIncorrectMinority = ((results.incorrectMinority / results.total) * 100).toFixed(2) + '%';
    const percentageTotal = '100.00%';

    // Ajouter les lignes de grand total au tableau
    const stats = [
        { label: 'Correct Majority', value: results.correctMajority, percentage: percentageCorrectMajority },
        { label: 'Correct Minority', value: results.correctMinority, percentage: percentageCorrectMinority },
        { label: 'Incorrect Majority', value: results.incorrectMajority, percentage: percentageIncorrectMajority },
        { label: 'Incorrect Minority', value: results.incorrectMinority, percentage: percentageIncorrectMinority },
        { label: 'Total', value: results.total, percentage: percentageTotal }
    ];

    stats.forEach(stat => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${stat.label}</strong></td>
            <td><strong>${stat.value}</strong></td>
            <td><strong>${stat.percentage}</strong></td>
        `;
        tbody.appendChild(row);
    });
}
//fin_display result  3


// processDataconsensus4
function processDataconsensus4() {
    if (csvData.length === 0) {
        alert('Veuillez d\'abord charger un fichier CSV.');
        return;
    }

    resetResultsTable();

    const headers = Object.keys(csvData[0]);
    const hitidIndex = headers.indexOf("hitid");
    const workeridIndex = headers.indexOf("workerid");
    const keyIndex = headers.indexOf("key");
    const correctnessIndex = headers.indexOf("Correctness");

    if (hitidIndex === -1 || workeridIndex === -1 || keyIndex === -1 || correctnessIndex === -1) {
        alert('Les en-têtes requis ne sont pas présents dans le fichier CSV.');
        return;
    }

    const hitidSet = new Set();
    const workeridSet = new Set();
    let keyCount = 0;
    let correctCount = 0;
    let incorrectCount = 0;

    csvData.forEach(row => {
        hitidSet.add(row["hitid"]);
        workeridSet.add(row["workerid"]);

        // Compter les valeurs uniques de 'key'
        if (!row["key"]) {
            return;
        }
        keyCount++;

        const correctness = row["Correctness"].toUpperCase();
        if (correctness === 'C') {
            correctCount++;
        } else if (correctness === 'I') {
            incorrectCount++;
        }
    });

    const globalAccuracy = ((correctCount / (correctCount + incorrectCount)) * 100).toFixed(2) + '%';

    const results = {
        uniqueHitids: hitidSet.size,
        uniqueWorkerids: workeridSet.size,
        uniqueKeys: keyCount,
        correctAsins: correctCount,
        incorrectAsins: incorrectCount,
        globalAccuracy: globalAccuracy
    };

    displayTotalResults4(results);
}

function displayTotalResults4(results) {
    const resultsTable = document.getElementById('resultsTable');
    resultsTable.innerHTML = `
        <thead>
            <tr>
                <th>Statistique</th>
                <th>Valeur</th>
            </tr>
        </thead>
        <tbody></tbody>`;

    const tbody = resultsTable.querySelector('tbody');

    // Ajouter les lignes de résultats au tableau
    const stats = [
        { label: 'Unique HITIDs', value: results.uniqueHitids },
        { label: 'WorkerIDs', value: results.uniqueWorkerids },
        { label: 'Unique ASIN Analyzed', value: results.uniqueKeys },
        { label: 'Correct ASINs', value: results.correctAsins },
        { label: 'Incorrect ASINs', value: results.incorrectAsins },
        { label: 'Global accuracy', value: results.globalAccuracy }
    ];

    stats.forEach(stat => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${stat.label}</strong></td>
            <td><strong>${stat.value}</strong></td>
        `;
        tbody.appendChild(row);
    });
}
//fin_display result 4




    </script>
</body>
</html>
